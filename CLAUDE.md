# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Flutter application called "Meal_ver2" - a Bible reading app that provides daily scripture verses with note-taking functionality. The app is built with Flutter SDK 3.5.1+ and integrates with Firebase for backend services.

## Development Commands

### Essential Commands
```bash
# Get dependencies
flutter pub get

# Run the app (defaults to connected device/emulator)
flutter run

# Run on specific device
flutter devices  # List all connected devices
flutter run -d <device_id>

# Hot reload: Press 'r' in terminal while app is running
# Hot restart: Press 'R' in terminal while app is running

# Code analysis
flutter analyze

# Run tests
flutter test

# Run a single test file
flutter test test/widget_test.dart
```

### Code Generation
The project uses `json_serializable` for JSON serialization. **IMPORTANT: Run this after modifying any model with `@JsonSerializable` annotation (e.g., `bible.dart`, `plan.dart`):**
```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

This generates `.g.dart` files (e.g., `bible.g.dart`, `plan.g.dart`) that contain serialization/deserialization code.

### Build Commands
```bash
# Android
flutter build apk              # Build APK
flutter build appbundle        # Build App Bundle for Play Store

# iOS
flutter build ios

# Web
flutter build web

# Generate native splash screens (after modifying flutter_native_splash.yaml)
flutter pub run flutter_native_splash:create
```

## Architecture

### Directory Structure
- **lib/** - Main application code
  - **model/** - Data models (PlanData, Verse, Bible with JSON serialization)
  - **view/** - UI screens (MainView, SelectBibleView, OptionView)
  - **viewmodel/** - ViewModels using Provider pattern (MainViewModel, CustomThemeMode)
  - **network/** - API and Firebase integration (FirebaseFunction, MealApi, Plan)
  - **util/** - Utilities (CustomTheme, Globals, PreferenceUtil)

- **bib_json/** - Bible translation JSON files (개역개정, 새번역, 공동번역, NASB, NIV, ESV, ISV)
- **font/** - Custom fonts (LINESeed, MaruBuri, Pretendard, RIDIBatang)
- **성경구절 전처리/** - Python scripts for Bible verse data preprocessing

### Key Technologies
- **State Management**: Provider pattern with ChangeNotifier
- **Backend**: Firebase (Auth, Firestore, Analytics, Storage)
- **Persistence**: SharedPreferences for local storage
- **Internationalization**: flutter_localizations (Korean/English support)
- **Navigation**: MaterialApp with custom theming
- **HTTP**: http package for API calls

### Core Components

1. **MainViewModel (lib/viewmodel/MainViewModel.dart)** - Central state management using Provider pattern
   - Extends `ChangeNotifier` for reactive state updates
   - Manages Bible data loading from JSON assets via `_loadBibleFile()`
   - Handles date selection and navigation with `setSelectedDate()`
   - Controls theme mode via static `ValueNotifier<ThemeMode>`
   - Manages user preferences (font size, spacing) with `SharedPreferences`
   - Implements CRUD operations for notes: `addNote()`, `updateNote()`, `deleteNote()`, `getNotesForDate()`
   - Handles multi-Bible loading with `loadMultipleBibles()`
   - Retrieves daily reading plans via Firebase Storage

2. **Bible Data Models**
   - **bible.dart**: Main Bible model with `@JsonSerializable` annotation → generates `bible.g.dart`
   - **plan.dart**: Daily reading plan model with `@JsonSerializable` annotation → generates `plan.g.dart`
   - **Verse.dart**: Simple verse model (no code generation)
   - **Note.dart**: Note model with `VerseReference` for linking verses
   - All models with code generation require running `build_runner` after modifications

3. **View Layer (lib/view/)**
   - **MainView.dart**: Primary screen with verse display, selection mode, date navigation
   - **SelectBibleView.dart**: Bible translation selection screen
   - **OptionView.dart**: Settings and preferences
   - **NoteEditorView.dart**: Create/edit notes linked to verses
   - **NotesListView.dart**: View all notes for a specific date

4. **Firebase Integration (lib/network/FirebaseFunction.dart)**
   - Anonymous authentication via `FirebaseAuth.signInAnonymously()`
   - Firebase Storage for reading plan data: `downloadFile()` retrieves `db.json`
   - Configured via `firebase_options.dart` (generated by FlutterFire CLI)
   - No Firestore usage despite dependency (local storage via SharedPreferences)

### Platform-Specific Configurations
- **Android**: Configured with Firebase (`google-services.json`), custom splash screens
- **iOS**: Configured with AppDelegate.swift, custom app icons
- **Web**: PWA support with manifest.json

## Important Patterns & Conventions

### State Management
- **Provider pattern** is used throughout the app with `ChangeNotifierProvider` at the root (`main.dart`)
- `MainViewModel` is created once at app startup with `SharedPreferences` injected
- UI components use `Consumer<MainViewModel>` or `Provider.of<MainViewModel>(context)` to access state
- Theme state uses `ValueNotifier<ThemeMode>` for lightweight reactivity without full Provider

### Data Persistence
- **SharedPreferences** is used for ALL local storage:
  - User preferences (theme, font size, spacing, selected Bibles)
  - Bible data (cached after first load from assets)
  - Notes data (serialized as JSON string with key `userNotes`)
  - Reading plan (key `mealPlan`)
- Firebase Storage is only used to fetch the latest reading plan (`db.json`)

### UI Conventions
- Custom fonts: **Mealfont** (UI text), **Settingfont** (settings), **Biblefont** (verse text)
- Text scaling is **disabled** globally (`textScaleFactor: 1.0` in `main.dart`) for consistent UI
- Korean locale (`ko_KR`) is primary; date formatting uses `intl` package
- Theme supports light/dark modes defined in `CustomTheme.dart`
- Navigation: Date changes via horizontal swipe gestures in `MainView`
- Selection mode: Long-press on verses activates multi-select with checkboxes

### Asset Loading
- Bible translations stored as JSON in `bib_json/` folder
- Loaded via `rootBundle.loadString()` and cached in SharedPreferences
- Available translations: 개역개정, 새번역, 공동번역, NASB
- Multiple translations can be displayed simultaneously in parallel columns

## Bible Notes Feature

### Overview
The app includes a note-taking system that allows users to create notes linked to specific Bible verses and dates.

### Implementation Details

1. **Note Data Model** (`lib/model/Note.dart`)
   - `Note.create()` factory generates unique IDs using milliseconds since epoch
   - Each note linked to specific date via `date` field and `dateKey` getter (format: "yyyy-MM-dd")
   - `VerseReference` class uniquely identifies verses: `verseId = "$bibleType:$book:$chapter:$verse"`
   - Notes stored in `MainViewModel._notesByDate` as `Map<String, List<Note>>`
   - Persisted to SharedPreferences as JSON under key `userNotes`

2. **Selection Mode in MainView**
   - State managed locally in `_Meal2ViewState`: `isSelectionMode`, `selectedVerseIds`, `selectedVerses`
   - Long press triggers `_enterSelectionMode()`
   - Back button or X icon calls `_exitSelectionMode()`
   - Selected verses highlighted with `Theme.primaryColor.withOpacity(0.1)`
   - Floating action button appears when `selectedVerseIds.isNotEmpty`

3. **Note Editor** (`lib/view/NoteEditorView.dart`)
   - Receives `List<VerseReference>` and `DateTime` from MainView
   - Creates new note via `Note.create()` or updates existing with `copyWith()`
   - Returns `true` to MainView on successful save

4. **Notes List** (`lib/view/NotesListView.dart`)
   - Displays notes for current date via `viewModel.getNotesForDate()`
   - Swipe gestures for date navigation
   - Notes icon in header shows total count via `viewModel.getNotesCountForDate()`

5. **Note Indicators in MainView**
   - Each verse checks `viewModel.hasNoteForVerse(date, verseRef)`
   - Shows small note icon next to verses that have associated notes
   - Hidden during selection mode

### User Flow
1. MainView → Long press verse → Selection mode activated
2. Select verses with checkboxes → Tap "노트 만들기" button
3. NoteEditorView opens → Enter title and content → Save
4. Returns to MainView → Note indicators appear on selected verses
5. Tap notes icon in header → NotesListView shows all notes for that date